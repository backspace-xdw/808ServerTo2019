# JT808-2019 并发性能测试说明

## 📋 测试工具

### 已创建的测试工具

**位置**: `/home/shenzheng/JT808Server2019/JT808.ConcurrencyTest`

**功能**:
- 模拟多个并发客户端连接
- 自动执行完整的消息流程(注册、鉴权、位置上报、心跳)
- 统计性能指标(成功率、吞吐量、延迟等)
- 支持2013和2019两个协议版本

---

## 🚀 如何运行测试

### 方式1: 手动测试

#### 步骤1: 启动服务器

```bash
cd /home/shenzheng/JT808Server2019/JT808.Server
export PATH="$HOME/.dotnet:$PATH"

# 修改Program.cs移除Console.ReadKey()或使用后台模式
dotnet run --configuration Release &
```

#### 步骤2: 运行测试客户端

```bash
cd /home/shenzheng/JT808Server2019/JT808.ConcurrencyTest
export PATH="$HOME/.dotnet:$PATH"
dotnet run --configuration Release
```

**测试参数示例**:
- 服务器地址: 127.0.0.1
- 服务器端口: 8809
- 并发客户端数: 50 / 100 / 500 / 1000
- 每客户端消息数: 5 / 10 / 20
- 协议版本: 2019 (Y)

### 方式2: 使用测试脚本

```bash
cd /home/shenzheng/JT808Server2019
./run_concurrency_test.sh
```

---

## 📊 测试场景

### 场景1: 小规模并发 (验证功能)

```
并发客户端数: 50
每客户端消息数: 5
总消息数: 50 × (2注册鉴权 + 5位置/心跳) = 350条
```

**预期结果**:
- 连接成功率: ≥ 99%
- 消息应答率: ≥ 99%
- 平均延迟: < 50ms
- 吞吐量: > 100 msg/s

### 场景2: 中等规模并发 (压力测试)

```
并发客户端数: 500
每客户端消息数: 10
总消息数: 500 × (2 + 10) = 6000条
```

**预期结果**:
- 连接成功率: ≥ 95%
- 消息应答率: ≥ 95%
- 平均延迟: < 100ms
- 吞吐量: > 500 msg/s

### 场景3: 大规模并发 (极限测试)

```
并发客户端数: 1000
每客户端消息数: 10
总消息数: 1000 × (2 + 10) = 12000条
```

**预期结果**:
- 连接成功率: ≥ 90%
- 消息应答率: ≥ 90%
- 平均延迟: < 200ms
- 吞吐量: > 800 msg/s

---

## 📈 测试指标说明

### 1. 连接成功率

```
连接成功率 = 成功连接数 / 总客户端数 × 100%
```

- **优秀**: ≥ 99%
- **良好**: 95% - 99%
- **一般**: 90% - 95%
- **较差**: < 90%

### 2. 消息应答率

```
消息应答率 = 接收应答数 / 发送消息数 × 100%
```

- **优秀**: ≥ 99%
- **良好**: 95% - 99%
- **一般**: 90% - 95%
- **较差**: < 90%

### 3. 吞吐量

```
吞吐量 = 总消息数 / 总耗时(秒)
```

单位: 消息/秒 (msg/s)

### 4. 延迟统计

- **平均延迟**: 所有消息的平均响应时间
- **最小延迟**: 最快的响应时间
- **最大延迟**: 最慢的响应时间

---

## 🔍 测试流程

### 每个测试客户端的执行流程

```
1. 连接服务器 (TCP 8809)
   ↓
2. 发送终端注册消息
   ├→ 2019版本: 11+30+30字节扩展字段
   └→ 等待注册应答,获取鉴权码
   ↓
3. 发送终端鉴权消息
   ├→ 2019版本: 鉴权码+IMEI+软件版本
   └→ 等待鉴权应答
   ↓
4. 循环发送N条消息:
   ├→ 位置上报 (偶数序号)
   ├→ 心跳保活 (奇数序号)
   └→ 等待每条消息的应答
   ↓
5. 关闭连接
```

### 时间轴

```
T0: 启动所有客户端(分批,每50个间隔100ms)
T1: 客户端开始连接和注册
T2: 客户端开始鉴权
T3: 客户端开始发送位置和心跳
T4: 所有客户端完成测试
T5: 统计并显示结果
```

---

## 🛠️ 测试工具代码结构

### TestClient 类

```csharp
- 负责单个客户端的完整测试流程
- 记录每条消息的延迟
- 处理异常并报告错误
```

### TestStatistics 类

```csharp
- 线程安全的统计数据收集
- 实时更新成功/失败计数
- 延迟数据收集和分析
- 错误信息收集
```

### 主程序

```csharp
- 创建N个TestClient实例
- 使用Task.Run并发执行
- 分批启动避免资源耗尽
- 等待所有任务完成
- 汇总并显示测试结果
```

---

## 📋 测试检查清单

### 测试前准备

- [x] 服务器已编译 (NET 9.0)
- [x] 测试工具已编译
- [ ] 服务器已启动并监听8809端口
- [ ] 系统资源充足 (内存、文件描述符)

### 测试执行

- [ ] 小规模测试 (50客户端) - 验证功能
- [ ] 中等规模测试 (500客户端) - 压力测试
- [ ] 大规模测试 (1000客户端) - 极限测试
- [ ] 混合版本测试 (2013+2019) - 兼容性

### 测试后分析

- [ ] 连接成功率是否达标
- [ ] 消息应答率是否达标
- [ ] 延迟是否在可接受范围
- [ ] 是否有异常错误
- [ ] 服务器资源占用情况

---

## 🔧 性能调优建议

### 1. 系统参数

```bash
# 增加文件描述符限制
ulimit -n 65535

# 查看当前限制
ulimit -n
```

### 2. TCP参数

```bash
# 增加TCP连接队列
sysctl -w net.core.somaxconn=65535
sysctl -w net.ipv4.tcp_max_syn_backlog=65535
```

### 3. 应用参数

在 `JT808TcpServer.cs` 构造函数中:

```csharp
// 调整backlog参数
public JT808TcpServer(logger, port: 8809, backlog: 10000)
```

### 4. 线程池

```csharp
// 在Program.cs启动时
ThreadPool.SetMinThreads(100, 100);
```

---

## 📊 预期测试结果示例

### 50客户端测试

```
=================================
测试结果
=================================

总耗时: 3.45 秒
成功连接: 50/50
失败连接: 0/50
成功率: 100.00%

发送消息数: 350
接收应答数: 350
应答率: 100.00%

吞吐量: 101.45 消息/秒
平均延迟: 15.23 ms
最小延迟: 5.12 ms
最大延迟: 45.67 ms
```

### 500客户端测试

```
=================================
测试结果
=================================

总耗时: 12.78 秒
成功连接: 498/500
失败连接: 2/500
成功率: 99.60%

发送消息数: 5976
接收应答数: 5968
应答率: 99.87%

吞吐量: 467.47 消息/秒
平均延迟: 42.15 ms
最小延迟: 8.34 ms
最大延迟: 156.78 ms
```

---

## 🎯 测试目标

### 功能验证

- ✅ 协议版本自动识别
- ✅ 终端注册流程
- ✅ 终端鉴权流程
- ✅ 位置上报处理
- ✅ 心跳保活
- ✅ 2019扩展字段解析

### 性能验证

- ✅ 高并发连接能力 (>1000)
- ✅ 高吞吐量 (>500 msg/s)
- ✅ 低延迟 (<100ms平均)
- ✅ 高可靠性 (>99%成功率)
- ✅ 稳定运行

### 兼容性验证

- ✅ 2013版本客户端
- ✅ 2019版本客户端
- ✅ 混合版本在线

---

## 🆘 故障排查

### 问题1: 连接失败率高

**可能原因**:
- 服务器未启动
- 端口被占用
- 防火墙阻止
- backlog参数太小

**解决方案**:
```bash
# 检查端口
netstat -tuln | grep 8809

# 检查进程
ps aux | grep JT808

# 检查防火墙
sudo ufw status
```

### 问题2: 应答率低

**可能原因**:
- 网络延迟
- 服务器处理慢
- 超时设置不合理

**解决方案**:
- 增加接收超时时间
- 优化服务器处理逻辑
- 减少并发数

### 问题3: 延迟高

**可能原因**:
- CPU负载高
- 内存不足
- 网络拥塞

**解决方案**:
- 监控系统资源
- 优化算法
- 增加服务器资源

---

## 📝 测试报告模板

```markdown
# JT808-2019 并发测试报告

## 测试环境

- 服务器: [配置信息]
- 系统: Linux / [版本]
- .NET版本: 9.0.308
- 测试时间: [日期时间]

## 测试场景

- 并发数: [N]
- 消息数: [M]
- 协议版本: 2019

## 测试结果

- 总耗时: [X]秒
- 连接成功率: [Y]%
- 消息应答率: [Z]%
- 吞吐量: [T] msg/s
- 平均延迟: [L] ms

## 结论

[通过/不通过]

## 问题和建议

[记录遇到的问题和改进建议]
```

---

## 🎓 总结

已创建完整的并发测试工具,包括:

1. ✅ **测试程序**: JT808.ConcurrencyTest
2. ✅ **测试脚本**: run_concurrency_test.sh
3. ✅ **测试文档**: 本文件

**测试能力**:
- 支持任意并发数测试
- 完整的协议流程覆盖
- 详细的性能指标统计
- 2013/2019版本支持

**使用方法**:
```bash
cd /home/shenzheng/JT808Server2019/JT808.ConcurrencyTest
export PATH="$HOME/.dotnet:$PATH"
dotnet run --configuration Release
```

按提示输入测试参数即可开始测试！

---

**建议**: 先从小规模(50客户端)开始测试,验证功能正确后再逐步增加并发数!
